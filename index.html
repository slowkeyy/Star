<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>500æ ¼å¾®è·ç›£æ§ç›¸æ©Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; }
        .monitor-active { border: 2px solid #22c55e; }
        .monitor-alert { border: 4px solid #ef4444; }
        
        /* ç¶²æ ¼è¦†è“‹å±¤ */
        #gridOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        /* éš±è—çš„åˆ†æç•«å¸ƒ */
        #analysisCanvas { display: none; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- é ‚éƒ¨è³‡è¨Š -->
    <div class="px-4 py-3 bg-slate-900 shadow-md z-30 flex justify-between items-center shrink-0">
        <div>
            <h1 class="text-lg font-bold text-white">ğŸ“¡ 500æ ¼çŸ©é™£ç›£æ§</h1>
            <div class="text-xs text-slate-400" id="statusText">ç­‰å¾…å•Ÿå‹•...</div>
        </div>
        <div class="text-right">
             <div class="text-xs text-slate-400">è§¸ç™¼ç¶²æ ¼æ•¸</div>
             <div id="activeGridCount" class="font-mono text-xl font-bold text-green-400">0</div>
        </div>
    </div>

    <!-- ä¸»ç•«é¢å€åŸŸ -->
    <div class="flex-1 relative bg-black flex justify-center items-center overflow-hidden">
        <div class="relative w-full h-full max-w-lg mx-auto bg-black">
            <!-- è¦–è¨Šç•«é¢ -->
            <video id="video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover"></video>
            
            <!-- è¦–è¦ºåŒ–ç¶²æ ¼å±¤ (ç”¨æ–¼é¡¯ç¤ºå“ªä¸€æ ¼åœ¨å‹•) -->
            <canvas id="gridOverlay"></canvas>

            <!-- è­¦å‘Šæ©«å¹… -->
            <div id="alertBanner" class="absolute top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hidden z-40 animate-bounce whitespace-nowrap">
                ğŸš¨ åµæ¸¬åˆ°è®ŠåŒ–!
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶å€ -->
    <div class="bg-slate-800 p-4 space-y-3 z-30 shrink-0 rounded-t-xl shadow-[0_-4px_10px_rgba(0,0,0,0.5)]">
        
        <div class="grid grid-cols-2 gap-4">
            <!-- éˆæ•åº¦æ§åˆ¶ -->
            <div>
                <div class="flex justify-between mb-1">
                    <label class="text-xs text-slate-300">éˆæ•åº¦ (è¶Šä½è¶Šæ•æ„Ÿ)</label>
                    <span id="thresholdValue" class="text-xs font-bold text-blue-400">40</span>
                </div>
                <input type="range" id="threshold" min="10" max="150" value="40" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- å†·å»æ™‚é–“æ§åˆ¶ -->
            <div>
                <div class="flex justify-between mb-1">
                    <label class="text-xs text-slate-300">å†·å»æ™‚é–“ (ç§’)</label>
                </div>
                <input type="number" id="cooldownInput" min="1" max="300" value="15" class="w-full h-8 bg-slate-700 border border-slate-600 rounded px-2 text-sm text-center focus:outline-none focus:border-blue-500 text-white">
            </div>
        </div>

        <!-- é–‹é—œ -->
        <div class="grid grid-cols-2 gap-3">
            <button id="startBtn" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold text-base active:scale-95 transition-all shadow-lg">
                å•Ÿå‹•ç›¸æ©Ÿ
            </button>
            <button id="stopBtn" class="bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg font-bold text-base active:scale-95 transition-all shadow-lg" disabled>
                åœæ­¢
            </button>
        </div>
        
        <!-- Log -->
        <div class="h-20 bg-black/50 rounded p-2 overflow-y-auto text-[10px] font-mono border border-slate-700 text-slate-300" id="logs">
            <div class="opacity-50">ç³»çµ±æº–å‚™å°±ç·’...</div>
        </div>
    </div>

    <!-- ç”¨æ–¼è¨ˆç®—çš„éš±è— Canvas (25x20 = 500æ ¼) -->
    <canvas id="analysisCanvas"></canvas>

    <script>
        // === è¨­å®š ===
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1465823372138254572/h2nNklSC_ka5xaGG9X0smuwJtREl1zkdIavYUDNJDQs9u_GU6lf3uI5fPE0FJ1eZELLg";
        
        // è¨­å®šç¶²æ ¼å¯†åº¦: 25è¡Œ x 20åˆ— = 500æ ¼
        const GRID_COLS = 25; 
        const GRID_ROWS = 20;

        // === DOM å…ƒç´  ===
        const video = document.getElementById('video');
        const analysisCanvas = document.getElementById('analysisCanvas');
        const analysisCtx = analysisCanvas.getContext('2d', { willReadFrequently: true });
        const gridOverlay = document.getElementById('gridOverlay');
        const gridCtx = gridOverlay.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusText = document.getElementById('statusText');
        const activeGridCountEl = document.getElementById('activeGridCount');
        const thresholdInput = document.getElementById('threshold');
        const thresholdValue = document.getElementById('thresholdValue');
        const cooldownInput = document.getElementById('cooldownInput');
        const logs = document.getElementById('logs');
        const alertBanner = document.getElementById('alertBanner');

        // === ç‹€æ…‹è®Šæ•¸ ===
        let stream = null;
        let isMonitoring = false;
        let lastFrameData = null; // å„²å­˜ 500 æ ¼çš„ RGB æ•¸æ“š
        let lastAlertTime = 0;
        let animationFrameId = null;

        // === éŸ³æ•ˆ Context (Web Audio API) ===
        let audioCtx = null;

        // === åˆå§‹åŒ– ===
        thresholdInput.addEventListener('input', (e) => {
            thresholdValue.textContent = e.target.value;
        });

        startBtn.addEventListener('click', () => {
            // åœ¨ä½¿ç”¨è€…é»æ“Šæ™‚åˆå§‹åŒ– AudioContext (é€™æ˜¯ç€è¦½å™¨æ”¿ç­–è¦æ±‚çš„)
            initAudio();
            startCamera();
        });
        
        stopBtn.addEventListener('click', stopCamera);

        // ç›£è½è¦–çª—å¤§å°æ”¹è®Šä»¥èª¿æ•´ Overlay å¤§å°
        window.addEventListener('resize', fitOverlayCanvas);

        function fitOverlayCanvas() {
            if (!video.videoWidth) return;
            // é€™è£¡ç°¡å–®å°‡ canvas è¨­ç‚ºé¡¯ç¤ºå¤§å°ï¼Œå¯¦éš›ç¹ªè£½æ™‚æœƒå°æ‡‰æ¯”ä¾‹
            gridOverlay.width = video.clientWidth;
            gridOverlay.height = video.clientHeight;
        }

        function initAudio() {
            if (!audioCtx) {
                // å…¼å®¹ä¸åŒç€è¦½å™¨
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            // ç¢ºä¿ Context æ˜¯é‹ä½œä¸­çš„
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // æ’­æ”¾ 1 ç§’é˜çš„ "å®å’š" è²
        function playAlarmSound() {
            if (!audioCtx) return;

            const now = audioCtx.currentTime;

            // --- ç¬¬ä¸€è² "å®" (é«˜éŸ³ C6 1046Hz) ---
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();

            osc1.type = 'triangle'; // ä¸‰è§’æ³¢ï¼ŒéŸ¿äº®ä¸”å¥½è½
            osc1.frequency.setValueAtTime(1046.5, now);
            
            // éŸ³é‡åŒ…çµ¡ (å¿«é€Ÿè®Šå¤§è²ï¼Œç„¶å¾Œæ…¢æ…¢æ¶ˆå¤±)
            gain1.gain.setValueAtTime(0, now);
            gain1.gain.linearRampToValueAtTime(1.0, now + 0.05);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.45);

            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            
            osc1.start(now);
            osc1.stop(now + 0.5); // 0.5ç§’å¾Œåœ

            // --- ç¬¬äºŒè² "å’š" (ä¸­éŸ³ G5 784Hz) ---
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();

            osc2.type = 'triangle';
            osc2.frequency.setValueAtTime(783.99, now + 0.5); // 0.5ç§’æ™‚é–‹å§‹
            
            // éŸ³é‡åŒ…çµ¡
            gain2.gain.setValueAtTime(0, now + 0.5);
            gain2.gain.linearRampToValueAtTime(1.0, now + 0.55);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 1.0);

            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            
            osc2.start(now + 0.5);
            osc2.stop(now + 1.1); // 1.1ç§’æ™‚å®Œå…¨çµæŸ
            
            addLog("ğŸ”Š å®å’šï¼");
        }

        async function startCamera() {
            try {
                addLog("è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...");
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: "environment", // å˜—è©¦å¾Œç½®
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    fitOverlayCanvas();
                    startMonitoring();
                };

                startBtn.disabled = true;
                startBtn.classList.add('opacity-50');
                stopBtn.disabled = false;
                stopBtn.classList.remove('opacity-50');
                addLog("âœ… ç›¸æ©Ÿå•Ÿå‹•ï¼Œåˆ‡æ›è‡³çŸ©é™£æ¨¡å¼");

            } catch (err) {
                console.error(err);
                addLog("âŒ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: " + err.message);
                alert("è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™æˆ–ä½¿ç”¨ HTTPS");
            }
        }

        function stopCamera() {
            isMonitoring = false;
            cancelAnimationFrame(animationFrameId);
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            // æ¸…ç©ºç¶²æ ¼
            gridCtx.clearRect(0, 0, gridOverlay.width, gridOverlay.height);
            activeGridCountEl.textContent = "0";
            activeGridCountEl.className = "font-mono text-xl font-bold text-green-400";
            alertBanner.classList.add('hidden');

            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50');
            statusText.textContent = "å·²åœæ­¢";
            addLog("ç›£æ§å·²åœæ­¢");
        }

        function startMonitoring() {
            isMonitoring = true;
            statusText.textContent = `ç›£æ§ä¸­ (500å€ç¶²æ ¼)`;
            statusText.className = "text-xs text-green-400 font-bold animate-pulse";
            
            // è¨­å®šåˆ†æç•«å¸ƒå¤§å°ç‚º 25x20 (æ¯å€‹åƒç´ ä»£è¡¨ä¸€æ ¼)
            analysisCanvas.width = GRID_COLS;
            analysisCanvas.height = GRID_ROWS;

            processFrame();
        }

        function processFrame() {
            if (!isMonitoring) return;

            // 1. å°‡æ•´å€‹ç•«é¢ç¸®å°ç¹ªè£½åˆ° 25x20 çš„ç•«å¸ƒä¸Š
            // ç€è¦½å™¨ç¸®æ”¾æ¼”ç®—æ³•æœƒè‡ªå‹•å¹«æˆ‘å€‘è¨ˆç®—å‡ºæ¯ä¸€æ ¼çš„å¹³å‡é¡è‰²
            analysisCtx.drawImage(video, 0, 0, GRID_COLS, GRID_ROWS);
            
            // 2. å–å‡ºé€™ 500 å€‹åƒç´ çš„è³‡æ–™
            const frameData = analysisCtx.getImageData(0, 0, GRID_COLS, GRID_ROWS).data;

            // 3. æº–å‚™ç¹ªè£½è¦–è¦ºåŒ–ç¶²æ ¼ (Overlay)
            // å…ˆæ¸…ç©ºä¸Šä¸€å¹€çš„ç´…æ¡†
            gridCtx.clearRect(0, 0, gridOverlay.width, gridOverlay.height);

            // è¨ˆç®— Overlay ä¸Šæ¯ä¸€æ ¼çš„é¡¯ç¤ºå¯¬é«˜
            const cellW = gridOverlay.width / GRID_COLS;
            const cellH = gridOverlay.height / GRID_ROWS;

            let triggeredCount = 0;
            const threshold = parseInt(thresholdInput.value);

            // 4. æ¯”å°æ¯ä¸€å€‹åƒç´  (å³æ¯ä¸€å€‹ç¶²æ ¼)
            if (lastFrameData) {
                gridCtx.fillStyle = 'rgba(255, 0, 0, 0.4)'; // è§¸ç™¼æ™‚çš„ç´…è‰²åŠé€æ˜é®ç½©

                for (let i = 0; i < frameData.length; i += 4) {
                    const rDiff = Math.abs(frameData[i] - lastFrameData[i]);
                    const gDiff = Math.abs(frameData[i+1] - lastFrameData[i+1]);
                    const bDiff = Math.abs(frameData[i+2] - lastFrameData[i+2]);
                    
                    // å–®æ ¼ç¸½å·®ç•°
                    const diff = rDiff + gDiff + bDiff;

                    // åˆ¤æ–·é€™ä¸€æ ¼æ˜¯å¦è¶…éé–€æª»
                    if (diff > threshold) {
                        triggeredCount++;
                        
                        // è¨ˆç®—é€™æ˜¯ç¬¬å¹¾è¡Œç¬¬å¹¾åˆ—
                        const pixelIndex = i / 4;
                        const x = pixelIndex % GRID_COLS;
                        const y = Math.floor(pixelIndex / GRID_COLS);

                        // åœ¨ç•«é¢ä¸Šå°æ‡‰ä½ç½®ç•«ç´…æ¡†
                        gridCtx.fillRect(x * cellW, y * cellH, cellW, cellH);
                    }
                }

                // æ›´æ–°UIæ•¸å€¼
                activeGridCountEl.textContent = triggeredCount;
                if (triggeredCount > 0) {
                    activeGridCountEl.className = "font-mono text-xl font-bold text-red-500 scale-110 transition-transform";
                } else {
                    activeGridCountEl.className = "font-mono text-xl font-bold text-green-400";
                }

                // 5. è§¸ç™¼é€šçŸ¥é‚è¼¯
                // è¨­å®šä¸€å€‹ã€Œæœ€å°è§¸ç™¼æ ¼æ•¸ã€ï¼Œé¿å…åªæœ‰ 1 æ ¼é›œè¨Šèª¤å ±ï¼Œé€™è£¡è¨­ç‚º 1 å³å¯å› ç‚ºæ˜¯é è·é›¢
                if (triggeredCount >= 1) {
                    handleAlert(triggeredCount);
                } else {
                    alertBanner.classList.add('hidden');
                }
            }

            // è¤‡è£½ç•¶å‰å¹€æ•¸æ“šåˆ°ä¸Šä¸€å¹€
            lastFrameData = new Uint8ClampedArray(frameData);

            animationFrameId = requestAnimationFrame(processFrame);
        }

        async function handleAlert(count) {
            const now = Date.now();
            
            // è®€å–ä½¿ç”¨è€…è¨­å®šçš„å†·å»æ™‚é–“
            let cooldownSeconds = parseInt(cooldownInput.value);
            if (isNaN(cooldownSeconds) || cooldownSeconds < 1) cooldownSeconds = 1;

            // é¡¯ç¤ºç´…è‰²æ©«å¹…
            alertBanner.classList.remove('hidden');
            alertBanner.textContent = `ğŸš¨ åµæ¸¬åˆ° ${count} æ ¼å€åŸŸè®ŠåŒ–!`;

            // å†·å»æ™‚é–“æª¢æŸ¥
            if (now - lastAlertTime > cooldownSeconds * 1000) {
                lastAlertTime = now;
                const msg = `ğŸ”” [500æ ¼çŸ©é™£] åµæ¸¬åˆ°è®ŠåŒ–ï¼\næ´»èºæ ¼æ•¸: ${count}/500\næ™‚é–“: ${new Date().toLocaleTimeString()}`;
                
                // 1. æ’­æ”¾è­¦å ±è²éŸ³ (æ–°å¢åŠŸèƒ½)
                playAlarmSound();

                addLog("ğŸ“¸ æ­£åœ¨æ“·å–ç•«é¢ä¸¦ç™¼é€...");
                
                try {
                    // å˜—è©¦æˆªåœ–
                    const imageBlob = await captureFrame();
                    await sendDiscordNotification(msg, imageBlob);
                } catch (e) {
                    console.error("æˆªåœ–å¤±æ•—:", e);
                    addLog("âš ï¸ æˆªåœ–å¤±æ•—ï¼Œåƒ…ç™¼é€æ–‡å­—");
                    await sendDiscordNotification(msg, null);
                }
            }
        }

        // æ–°å¢ï¼šæˆªå–ç•¶å‰å½±ç‰‡å¹€
        function captureFrame() {
            if (!video.videoWidth) return null;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.8);
            });
        }

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            div.className = "mb-1 border-b border-slate-700 pb-1";
            logs.insertBefore(div, logs.firstChild);
            if (logs.children.length > 30) logs.removeChild(logs.lastChild);
        }

        async function sendDiscordNotification(content, imageBlob) {
            
            const formData = new FormData();
            
            // Discord Webhook æ”¯æ´ multipart/form-data
            // payload_json æ¬„ä½ç”¨æ–¼å‚³é JSON è³‡æ–™
            const payload = {
                content: content,
                username: "çŸ©é™£ç›£æ§ Bot",
                avatar_url: "https://i.imgur.com/A66428u.png"
            };
            
            formData.append('payload_json', JSON.stringify(payload));
            
            if (imageBlob) {
                formData.append('file', imageBlob, 'snapshot.jpg');
            }

            try {
                // ä½¿ç”¨ FormData æ™‚ä¸éœ€è¦è¨­å®š Content-Typeï¼Œç€è¦½å™¨æœƒè‡ªå‹•è™•ç† boundary
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) addLog("âœ… é€šçŸ¥èˆ‡åœ–ç‰‡å·²ç™¼é€");
                else addLog(`âŒ å¤±æ•—: ${response.status}`);
            } catch (error) {
                console.error(error);
                addLog("âŒ ç¶²çµ¡/CORS éŒ¯èª¤");
            }
        }
    </script>
</body>
</html>


